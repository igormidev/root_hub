# Root Hub Server (Serverpod)

Backend for Root Hub. This server provides authentication, match-making APIs, social APIs, match result registration, and location lookup.

## What This Server Does
- Authenticates users with Serverpod IDP (email + JWT refresh).
- Stores player profiles and game metadata.
- Supports match schedule creation and subscription.
- Supports in-match chat.
- Supports post/comment social feed.
- Registers played match results for future rating/ranking logic.
- Serves `assets/config.json` for the Flutter app at `/app/assets/assets/config.json`.

## Structure Map

```text
root_hub_server/
├── bin/
│   └── main.dart
├── config/
│   ├── generator.yaml
│   ├── development.yaml
│   ├── test.yaml
│   ├── staging.yaml
│   ├── production.yaml
│   └── passwords.yaml
├── lib/
│   ├── server.dart
│   └── src/
│       ├── api/
│       │   ├── account/
│       │   ├── community/
│       │   ├── match/
│       │   ├── match_chat/
│       │   └── match_making/
│       ├── auth/
│       ├── core/
│       ├── entities/                  # Source-of-truth .spy.yaml models
│       ├── generated/                 # Generated Dart protocol/endpoints/models
│       └── web/
│           ├── routes/
│           └── widgets/
├── migrations/
├── test/
│   └── integration/test_tools/
├── web/
│   ├── app/                           # Built Flutter web (generated by build script)
│   ├── pages/
│   ├── static/
│   └── templates/
├── docker-compose.yaml
└── pubspec.yaml
```

## Runtime Entry Points
- `bin/main.dart`: boot entrypoint that calls `run(args)` from `lib/server.dart`.
- `lib/server.dart`:
  - initializes `Serverpod` with generated `Protocol()` and `Endpoints()`.
  - configures auth services (`JwtConfigFromPasswords`, `EmailIdpConfigFromPasswords`).
  - registers web routes:
    - `/` and `/index.html` => built-with-serverpod page.
    - `/app/assets/assets/config.json` => app config JSON consumed by Flutter.
    - `/app/**` => Flutter web app (if built) or fallback page.

## API Modules

### `account`
- `create_player_data.dart`: creates `PlayerData` for authenticated user (idempotent conflict handling).
- `get_account.dart`: returns authenticated user profile.

### `community`
- `create_post_endpoint.dart` + `mixin/create_post_mixin.dart`: creates social posts.
- `get_posts_endpoint.dart`: paginated posts with optional language filter.
- `create_comment_endpoint.dart`: creates post comments.
- `get_comments_endpoint.dart`: paginated comments by post.

### `match_making`
- `create_match_schedule.dart`: creates `MatchSchedulePairingAttempt` + related chat history.
- `subscribe_to_match.dart`: subscribes player to scheduled match.
- `get_player_subscribed_matches.dart`: paginated subscriptions.
- `get_match_location.dart`: queries Google Places, upserts local location wrappers.

### `match_chat`
- `match_chat_get_messages.dart`: list chat messages for authorized participants.
- `match_chat_send_message.dart`: send message to match chat.

### `match`
- `register_match_data.dart`: validates and persists played match + participants + performances.
- `get_my_played_matches.dart`: endpoint declared but intentionally not implemented yet.

## Authentication
- Server auth is enabled in `lib/server.dart`.
- Endpoints that require login declare `@override bool get requireLogin => true;`.
- Auth endpoints are exposed by:
  - `lib/src/auth/email_idp_endpoint.dart`
  - `lib/src/auth/jwt_refresh_endpoint.dart`

## Error Handling Pattern
- Centralized helpers in `lib/src/core/root_hub_endpoint_error.dart`.
- Endpoints use `guardRootHubEndpointErrors(...)` to convert unexpected exceptions into `RootHubException` payloads.

## Domain Models
Source model definitions live in `lib/src/entities/**/*.spy.yaml` and API payload models in `lib/src/api/**/models/*.spy.yaml`.
Generated equivalents are produced into `lib/src/generated/**`.

Do not manually edit generated files under `lib/src/generated/**`.

## Configuration
- Environment config: `config/development.yaml`, `config/test.yaml`, `config/staging.yaml`, `config/production.yaml`.
- Secrets: `config/passwords.yaml` (for local/dev secrets and environment-specific secrets).
- Google Places key used by `get_match_location.dart`:
  - `googleMapsApiKey` in `config/passwords.yaml`, or
  - `GOOGLE_MAPS_API_KEY` environment variable.

## Local Infrastructure
Use Docker for local database services:

```bash
cd /Users/igor/PersonalProjects/root_hub/root_hub_server
docker compose up --build --detach
```

Services:
- Postgres (`8090`) + Redis (`8091`) for development.
- Postgres (`9090`) + Redis (`9091`) for tests.

## Migrations
Migration artifacts are under `migrations/` with timestamped folders and `migration_registry.txt`.

## Development Commands
From `/Users/igor/PersonalProjects/root_hub/root_hub_server`:

```bash
dart pub get
serverpod generate
dart analyze
dart bin/main.dart --apply-migrations
```

## Integration with Other Workspace Packages
- `config/generator.yaml` points `client_package_path` to `../root_hub_client`.
- Running `serverpod generate` updates both server generated files and client protocol files.

## Operational Notes
- If endpoint signatures, `.spy.yaml` models, or folder-level architecture changes, update this README in the same change.
- Keep generated and source-of-truth files clearly separated (`entities/` + `api/**/models/` vs `generated/`).
